<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Professioneller Arbeitszeit-Rechner mit speziellen Zuschlagsregelungen, 3-Stunden-Regel und Monatsauswertung für deutsche Arbeitszeiten.">
    <meta name="keywords" content="Arbeitszeit, Rechner, Zuschläge, Stundenliste, Überstunden, Arbeitszeit berechnen">
    <meta name="author" content="Arbeitszeit-Rechner">
    
    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Arbeitszeit-Rechner - Professionelle Zeiterfassung">
    <meta property="og:description" content="Berechnen Sie Arbeitszeiten mit speziellen Zuschlagsregelungen, 3-Stunden-Regel und erstellen Sie Monatslisten.">
    <meta property="og:image" content="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1200' height='630' viewBox='0 0 1200 630'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23764ba2;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='1200' height='630' fill='url(%23grad)'/%3E%3Ctext x='600' y='300' font-family='Arial, sans-serif' font-size='72' font-weight='bold' text-anchor='middle' fill='white'%3E⏰ Arbeitszeit-Rechner%3C/text%3E%3Ctext x='600' y='380' font-family='Arial, sans-serif' font-size='32' text-anchor='middle' fill='white' opacity='0.9'%3EProfessionelle Zeiterfassung mit Zuschlagsregelungen%3C/text%3E%3C/svg%3E">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='15' fill='%23667eea'/%3E%3Ctext x='16' y='22' font-family='Arial' font-size='18' text-anchor='middle' fill='white'%3E⏰%3C/text%3E%3C/svg%3E">
    
    <title>Arbeitszeit-Rechner mit Monatsliste</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .content {
            padding: 30px;
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .mode-btn {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .input-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .input-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .form-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-field {
            display: flex;
            flex-direction: column;
        }

        label {
            color: #495057;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        input, select {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .time-input-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .time-input-group select {
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 0.9rem;
            min-width: 60px;
        }

        .time-separator {
            font-weight: bold;
            color: #495057;
        }

        .time-input-quick {
            width: 60px;
            padding: 4px;
            font-size: 0.8rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
        }

        .time-input-quick:focus {
            border-color: #667eea;
            background-color: #f0f8ff;
            outline: none;
        }

        .day-inputs-quick {
            display: grid;
            grid-template-columns: 60px 60px;
            gap: 5px;
            margin-bottom: 10px;
            align-items: center;
        }

        .input-labels {
            display: grid;
            grid-template-columns: 60px 60px;
            gap: 5px;
            margin-bottom: 5px;
            font-size: 0.7rem;
            color: #666;
        }

        .day-inputs-additional {
            display: grid;
            grid-template-columns: 60px 60px;
            gap: 5px;
            margin-bottom: 5px;
            align-items: center;
        }

        .time-blocks {
            display: grid;
            gap: 20px;
        }

        .time-block {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
        }

        .time-block h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 25px 0;
        }

        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }

        .btn-secondary:hover {
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .btn-success:hover {
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .results {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
        }

        .results h3 {
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .result-item .label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .result-item .value {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .rules-info {
            background: #e3f2fd;
            border: 2px solid #bbdefb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #1565c0;
        }

        .rules-info h4 {
            margin-bottom: 10px;
            color: #0d47a1;
        }

        .month-header {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .month-calendar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .day-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .day-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            flex-wrap: wrap;
        }

        .day-number {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
            min-width: 30px;
        }

        .weekday {
            font-size: 0.9rem;
            color: #6c757d;
            text-align: right;
            flex: 1;
            margin-left: 10px;
        }

        .day-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .day-inputs input {
            padding: 8px;
            font-size: 0.9rem;
        }

        .day-summary {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            color: #495057;
        }

        .month-summary {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
        }

        .export-section {
            text-align: center;
            margin-top: 20px;
        }

        .print-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .print-table th,
        .print-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .print-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .print-table tr:hover {
            background: #f8f9fa;
        }

        .footer {
            background: #f8f9fa;
            border-top: 2px solid #e9ecef;
            padding: 20px;
            text-align: center;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .footer a {
            color: #667eea;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .content {
                padding: 20px;
            }
            
            .form-group {
                grid-template-columns: 1fr;
            }
            
            .time-blocks {
                grid-template-columns: 1fr;
            }

            .month-calendar {
                grid-template-columns: 1fr;
            }

            .mode-selector {
                flex-direction: column;
                align-items: center;
            }

            .day-inputs {
                grid-template-columns: 1fr;
            }
        }

        @media print {
            body {
                background: white;
            }
            .container {
                box-shadow: none;
                background: white;
            }
            .mode-selector,
            .button-group,
            .export-section,
            .footer {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⏰ Arbeitszeit-Rechner</h1>
            <p>Einzelberechnung und Monatsliste mit speziellen Zuschlagsregelungen</p>
        </div>
        
        <div class="content">
            <div class="mode-selector">
                <div class="mode-btn active" onclick="switchMode('single')">
                    📋 Einzelberechnung
                </div>
                <div class="mode-btn" onclick="switchMode('monthly')">
                    📅 Monatsliste
                </div>
            </div>

            <!-- Einzelberechnung -->
            <div id="single-mode" class="section active">
                <div class="rules-info">
                    <h4>📋 Arbeitszeit-Regelungen:</h4>
                    <p><strong>🌙 Nachtzeiten (Mo-Sa):</strong> 22:00-06:00 Uhr = 100% steuerfrei</p>
                    <p><strong>🎉 Wochenende:</strong> Sa 22:00 bis Mo 06:00 = 100% steuerfrei</p>
                    <p><strong>🎉 Sonntag & Feiertag:</strong> 00:00-24:00 Uhr = 100% steuerfrei</p>
                    <p><strong>🎯 Österreichische Feiertage werden automatisch erkannt!</strong> (Neujahr, Heilige Drei Könige, Ostermontag, Tag der Arbeit, Christi Himmelfahrt, Pfingstmontag, Fronleichnam, Mariä Himmelfahrt, Nationalfeiertag, Allerheiligen, Mariä Empfängnis, Weihnachten, Stefanitag)</p>
                    <p><strong>🕐 3-Stunden-Regel (nur Werktage Mo-Sa):</strong><br>
                    Wenn eine Arbeitszeit von 19:00 bis mindestens 22:00 Uhr geht (mindestens 3 Stunden), dann ist der Zeitraum ab 19:00 Uhr bis zum Ende 100% steuerfrei. Der Teil vor 19:00 wird normal berechnet.</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>✅ Teilweise steuerfrei:</strong> 07:30-22:45 → vor 19:00 normal, ab 19:00 steuerfrei</li>
                        <li><strong>✅ Komplett steuerfrei:</strong> 19:00-22:00 (nur Abendschicht)</li>
                        <li><strong>✅ Komplett steuerfrei:</strong> 20:00-23:30 (nur Abendschicht)</li>
                        <li><strong>✅ Teilweise steuerfrei:</strong> 16:00-23:00 → 16:00-19:00 normal, 19:00-23:00 steuerfrei</li>
                        <li><strong>❌ Normal berechnet:</strong> 19:00-21:30 (nur 2,5 Stunden, nicht bis 22:00)</li>
                    </ul>
                    <p><strong>📋 Pausenregelung:</strong> Kreuzen Sie "Pause" pro Tag an, wenn eine 45-Minuten-Pause von der Arbeitszeit abgezogen werden soll.</p>
                </div>

                <div class="input-section">
                    <h3>📅 Arbeitszeit eingeben</h3>
                    
                    <div class="form-group">
                        <div class="form-field">
                            <label for="workday">Wochentag</label>
                            <select id="workday">
                                <option value="monday">Montag</option>
                                <option value="tuesday">Dienstag</option>
                                <option value="wednesday">Mittwoch</option>
                                <option value="thursday">Donnerstag</option>
                                <option value="friday">Freitag</option>
                                <option value="saturday">Samstag</option>
                                <option value="sunday">Sonntag</option>
                            </select>
                        </div>
                        
                        <div class="form-field">
                            <label for="isHoliday">Feiertag?</label>
                            <select id="isHoliday">
                                <option value="false">Nein</option>
                                <option value="true">Ja</option>
                            </select>
                        </div>
                        
                        <div class="form-field">
                            <label>
                                <input type="checkbox" id="hasPause"> Mittagspause (0:45h) abziehen
                            </label>
                        </div>
                    </div>

                    <div class="time-blocks">
                        <div class="time-block">
                            <h4>🕐 Hauptarbeitszeit</h4>
                            <div class="form-group">
                                <div class="form-field">
                                    <label>Beginn</label>
                                    <div class="time-input-group">
                                        <select id="startHour1">
                                            <option value="">--</option>
                                        </select>
                                        <span class="time-separator">:</span>
                                        <select id="startMin1">
                                            <option value="">--</option>
                                            <option value="00">00</option>
                                            <option value="15">15</option>
                                            <option value="30">30</option>
                                            <option value="45">45</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-field">
                                    <label>Ende</label>
                                    <div class="time-input-group">
                                        <select id="endHour1">
                                            <option value="">--</option>
                                        </select>
                                        <span class="time-separator">:</span>
                                        <select id="endMin1">
                                            <option value="">--</option>
                                            <option value="00">00</option>
                                            <option value="15">15</option>
                                            <option value="30">30</option>
                                            <option value="45">45</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="additionalTimeBlocks">
                            <!-- Zusätzliche Arbeitszeit-Blöcke werden hier dynamisch hinzugefügt -->
                        </div>

                        <div style="text-align: center; margin: 15px 0;">
                            <button type="button" onclick="addTimeBlock()" class="btn-success" style="min-width: auto; padding: 8px 15px;">+ Weitere Arbeitszeit</button>
                            <button type="button" onclick="removeTimeBlock()" class="btn-secondary" style="min-width: auto; padding: 8px 15px;">- Entfernen</button>
                        </div>
                    </div>

                    <div class="button-group">
                        <button onclick="calculateWorkTime()">🧮 Berechnen</button>
                        <button class="btn-secondary" onclick="clearSingle()">🗑️ Zurücksetzen</button>
                    </div>
                </div>

                <div id="results" class="results" style="display: none;">
                    <h3>📊 Berechnungsergebnis</h3>
                    <div id="resultContent" class="result-grid"></div>
                </div>
            </div>

            <!-- Monatsliste -->
            <div id="monthly-mode" class="section">
                <div class="month-header">
                    <h3>📅 Monatsliste erstellen</h3>
                    
                    <div class="form-group">
                        <div class="form-field">
                            <label for="employeeName">Name</label>
                            <input type="text" id="employeeName" placeholder="Name des Mitarbeiters">
                        </div>
                        
                        <div class="form-field">
                            <label for="selectedMonth">Monat</label>
                            <input type="month" id="selectedMonth">
                        </div>
                    </div>

                    <div class="button-group">
                        <button onclick="generateMonthCalendar()">📋 Monat generieren</button>
                        <button class="btn-success" onclick="calculateMonthTotal()">📊 Monatsauswertung</button>
                        <button class="btn-secondary" onclick="clearMonth()">🗑️ Zurücksetzen</button>
                    </div>
                </div>

                <div id="holidaysInfo" style="display: none;" class="rules-info">
                    <h4>🎉 Feiertage in diesem Monat:</h4>
                    <div id="holidaysList"></div>
                </div>

                <div id="monthCalendar" class="month-calendar"></div>

                <div id="monthSummary" class="month-summary" style="display: none;">
                    <h3>📊 Monatsauswertung</h3>
                    <div id="monthSummaryContent"></div>
                    
                    <div class="export-section">
                        <button onclick="printOfficialPDF()" class="btn-secondary">🖨️ Offizielle Stundenliste drucken</button>
                    </div>
                </div>

                <div id="printTable" style="display: none;"></div>
            </div>
        </div>
        
        <div class="footer">
            <p>⏰ Arbeitszeit-Rechner - Professionelle Zeiterfassung | 
            <a href="https://github.com" target="_blank" rel="noopener">📂 GitHub Repository</a></p>
        </div>
    </div>

    <script>
        let monthData = {};
        let singleModeTimeBlocks = 1; // Startet mit 1 Block

        function formatTimeInput(input) {
            let value = input.value.replace(/[^\d]/g, ''); // Nur Zahlen
            
            if (value.length === 0) {
                input.value = '';
                return;
            }
            
            // Auto-Format verschiedener Eingaben
            if (value.length <= 2) {
                // 1-2 Stellen: als Stunden interpretieren
                let hours = parseInt(value);
                if (hours > 23) hours = 23;
                input.value = hours.toString().padStart(2, '0') + ':00';
            } else if (value.length === 3) {
                // 3 Stellen: erste als Stunde, letzte zwei als Minuten (z.B. 730 -> 07:30)
                let hours = parseInt(value.substring(0, 1));
                let minutes = parseInt(value.substring(1, 3));
                if (hours > 23) hours = 23;
                if (minutes > 59) minutes = 59;
                // Runde auf 15-Minuten-Schritte
                minutes = Math.round(minutes / 15) * 15;
                if (minutes === 60) { minutes = 0; hours++; }
                if (hours > 23) hours = 23;
                input.value = hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0');
            } else if (value.length >= 4) {
                // 4+ Stellen: erste zwei als Stunden, nächste zwei als Minuten
                let hours = parseInt(value.substring(0, 2));
                let minutes = parseInt(value.substring(2, 4));
                if (hours > 23) hours = 23;
                if (minutes > 59) minutes = 59;
                // Runde auf 15-Minuten-Schritte
                minutes = Math.round(minutes / 15) * 15;
                if (minutes === 60) { minutes = 0; hours++; }
                if (hours > 23) hours = 23;
                input.value = hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0');
            }
        }

        function handleTimeKeyDown(event) {
            // Enter oder Tab: zum nächsten Feld
            if (event.key === 'Enter' || event.key === 'Tab') {
                formatTimeInput(event.target);
                updateDaySummary(event.target.dataset.day);
                
                if (event.key === 'Enter') {
                    event.preventDefault();
                    // Finde nächstes Eingabefeld
                    const inputs = Array.from(document.querySelectorAll('.time-input-quick'));
                    const currentIndex = inputs.indexOf(event.target);
                    const nextInput = inputs[currentIndex + 1];
                    if (nextInput) {
                        nextInput.focus();
                        nextInput.select();
                    }
                }
            }
        }

        function handleTimeBlur(event) {
            formatTimeInput(event.target);
            updateDaySummary(event.target.dataset.day);
        }

        function validateTimeBlocks(timeBlocks) {
            if (timeBlocks.length <= 1) return { valid: true };
            
            // Konvertiere alle Zeiten zu Minuten und sortiere nach Startzeit
            const timeRanges = timeBlocks.map(block => ({
                start: timeToMinutes(block.start),
                end: timeToMinutes(block.end),
                startStr: block.start,
                endStr: block.end
            })).sort((a, b) => a.start - b.start);
            
            // Prüfe auf Überschneidungen
            for (let i = 0; i < timeRanges.length - 1; i++) {
                const current = timeRanges[i];
                const next = timeRanges[i + 1];
                
                // Behandle Zeiten über Mitternacht
                let currentEnd = current.end;
                let nextStart = next.start;
                
                if (current.end < current.start) {
                    currentEnd += 1440; // 24 Stunden hinzufügen
                }
                if (next.end < next.start) {
                    nextStart += 1440; // 24 Stunden hinzufügen
                }
                
                // Prüfe Überschneidung
                if (currentEnd > nextStart) {
                    return {
                        valid: false,
                        message: `⚠️ Zeitüberschneidung erkannt!\n\nArbeitszeit 1: ${current.startStr} - ${current.endStr}\nArbeitszeit 2: ${next.startStr} - ${next.endStr}\n\nBitte korrigieren Sie die Zeiten so, dass sie sich nicht überschneiden.`
                    };
                }
            }
            
            return { valid: true };
        }

        function getTimeFromInput(inputId) {
            const input = document.getElementById(inputId);
            return input ? input.value : '';
        }

        function populateHourOptions(selectElement) {
            if (!selectElement) {
                return;
            }
            
            // Lösche existierende Optionen außer der ersten (die "--" Option)
            while (selectElement.children.length > 1) {
                selectElement.removeChild(selectElement.lastChild);
            }
            
            for (let i = 0; i < 24; i++) {
                const option = document.createElement('option');
                const hourStr = i.toString().padStart(2, '0');
                option.value = hourStr;
                option.textContent = hourStr;
                selectElement.appendChild(option);
            }
        }

        function getTimeFromSelects(hourSelectId, minSelectId) {
            const hourSelect = document.getElementById(hourSelectId);
            const minSelect = document.getElementById(minSelectId);
            
            if (!hourSelect || !minSelect || !hourSelect.value || !minSelect.value) {
                return '';
            }
            
            return `${hourSelect.value}:${minSelect.value}`;
        }

        function setTimeToSelects(hourSelectId, minSelectId, timeStr) {
            if (!timeStr) return;
            
            const [hours, minutes] = timeStr.split(':');
            const hourSelect = document.getElementById(hourSelectId);
            const minSelect = document.getElementById(minSelectId);
            
            if (hourSelect && minSelect) {
                hourSelect.value = hours;
                minSelect.value = minutes;
            }
        }

        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function addDayTimeBlock(day) {
            if (!monthData[day]) return;
            
            monthData[day].timeBlocks++;
            const timeInputsDiv = document.getElementById(`timeInputs_${day}`);
            const blockNum = monthData[day].timeBlocks;
            
            const newInputs = document.createElement('div');
            newInputs.className = 'day-inputs-additional';
            newInputs.id = `timeBlock_${day}_${blockNum}`;
            newInputs.style.marginTop = '5px';
            
            // Erste zusätzliche Arbeitszeit bekommt Labels
            if (blockNum === 2) {
                newInputs.innerHTML = `
                    <div style="grid-column: span 2; font-size: 0.7rem; color: #666; margin-bottom: 3px; display: grid; grid-template-columns: 60px 60px; gap: 5px;">
                        <div>Beginn ${blockNum}</div>
                        <div>Ende ${blockNum}</div>
                    </div>
                    <input type="text" 
                           class="time-input-quick" 
                           id="start${blockNum}_${day}" 
                           data-day="${day}"
                           placeholder="18:00"
                           onkeydown="handleTimeKeyDown(event)"
                           onblur="handleTimeBlur(event)"
                           tabindex="${day * 10 + blockNum * 2 + 1}">
                    <input type="text" 
                           class="time-input-quick" 
                           id="end${blockNum}_${day}" 
                           data-day="${day}"
                           placeholder="22:00"
                           onkeydown="handleTimeKeyDown(event)"
                           onblur="handleTimeBlur(event)"
                           tabindex="${day * 10 + blockNum * 2 + 2}">
                `;
            } else {
                // Weitere Blöcke ohne Labels
                newInputs.innerHTML = `
                    <input type="text" 
                           class="time-input-quick" 
                           id="start${blockNum}_${day}" 
                           data-day="${day}"
                           placeholder="--:--"
                           onkeydown="handleTimeKeyDown(event)"
                           onblur="handleTimeBlur(event)"
                           tabindex="${day * 10 + blockNum * 2 + 1}">
                    <input type="text" 
                           class="time-input-quick" 
                           id="end${blockNum}_${day}" 
                           data-day="${day}"
                           placeholder="--:--"
                           onkeydown="handleTimeKeyDown(event)"
                           onblur="handleTimeBlur(event)"
                           tabindex="${day * 10 + blockNum * 2 + 2}">
                `;
            }
            
            timeInputsDiv.appendChild(newInputs);
        }

        function removeDayTimeBlock(day) {
            if (!monthData[day] || monthData[day].timeBlocks <= 1) return;
            
            const blockToRemove = document.getElementById(`timeBlock_${day}_${monthData[day].timeBlocks}`);
            if (blockToRemove) {
                blockToRemove.remove();
                monthData[day].timeBlocks--;
                updateDaySummary(day);
            }
        }

        function copyToWeek(day) {
            if (!monthData[day]) return;
            
            const startTime1 = getTimeFromInput(`start1_${day}`);
            const endTime1 = getTimeFromInput(`end1_${day}`);
            const isHoliday = document.getElementById(`holiday_${day}`).checked;
            const hasPause = document.getElementById(`pause_${day}`).checked;
            const dienst1 = document.getElementById(`dienst1_${day}`).checked;
            const dienst2 = document.getElementById(`dienst2_${day}`).checked;
            const einsatzpauschalen = parseInt(document.getElementById(`einsatzpauschalen_${day}`).value) || 0;
            const krankUrlaub = document.getElementById(`krankUrlaub_${day}`).value;
            const diaeten = document.getElementById(`diaeten_${day}`).value;
            const zeitausgleich = getTimeFromDropdowns(`zeitausgleichH_${day}`, `zeitausgleichM_${day}`);
            const zeitFirma = getTimeFromDropdowns(`zeitFirmaH_${day}`, `zeitFirmaM_${day}`);
            
            const hasAnyData = startTime1 || endTime1 || dienst1 || dienst2 || einsatzpauschalen > 0 || 
                             krankUrlaub || diaeten || zeitausgleich || zeitFirma;
            
            if (!hasAnyData) {
                alert('Bitte erst Zeiten oder andere Daten für diesen Tag eingeben.');
                return;
            }
            
            // Sammle alle zusätzlichen Arbeitszeiten
            const additionalTimes = [];
            for (let i = 2; i <= monthData[day].timeBlocks; i++) {
                const start = getTimeFromInput(`start${i}_${day}`);
                const end = getTimeFromInput(`end${i}_${day}`);
                if (start && end) {
                    additionalTimes.push({ start, end });
                }
            }
            
            // Finde alle Tage der gleichen Woche
            const currentDate = monthData[day].date;
            const monday = new Date(currentDate);
            monday.setDate(currentDate.getDate() - currentDate.getDay() + 1);
            
            for (let i = 0; i < 7; i++) {
                const targetDate = new Date(monday);
                targetDate.setDate(monday.getDate() + i);
                const targetDay = targetDate.getDate();
                
                if (monthData[targetDay] && targetDay !== day) {
                    // Grunddaten setzen
                    const targetInput1 = document.getElementById(`start1_${targetDay}`);
                    const targetInput2 = document.getElementById(`end1_${targetDay}`);
                    const targetHoliday = document.getElementById(`holiday_${targetDay}`);
                    const targetPause = document.getElementById(`pause_${targetDay}`);
                    const targetDienst1 = document.getElementById(`dienst1_${targetDay}`);
                    const targetDienst2 = document.getElementById(`dienst2_${targetDay}`);
                    const targetEinsatzpauschalen = document.getElementById(`einsatzpauschalen_${targetDay}`);
                    const targetKrankUrlaub = document.getElementById(`krankUrlaub_${targetDay}`);
                    const targetDiaeten = document.getElementById(`diaeten_${targetDay}`);
                    const targetZeitausgleichH = document.getElementById(`zeitausgleichH_${targetDay}`);
                    const targetZeitausgleichM = document.getElementById(`zeitausgleichM_${targetDay}`);
                    const targetZeitFirmaH = document.getElementById(`zeitFirmaH_${targetDay}`);
                    const targetZeitFirmaM = document.getElementById(`zeitFirmaM_${targetDay}`);
                    
                    if (targetInput1) targetInput1.value = startTime1;
                    if (targetInput2) targetInput2.value = endTime1;
                    if (targetHoliday) targetHoliday.checked = isHoliday;
                    if (targetPause) targetPause.checked = hasPause;
                    if (targetDienst1) targetDienst1.checked = dienst1;
                    if (targetDienst2) targetDienst2.checked = dienst2;
                    if (targetEinsatzpauschalen) targetEinsatzpauschalen.value = einsatzpauschalen;
                    if (targetKrankUrlaub) targetKrankUrlaub.value = krankUrlaub;
                    if (targetDiaeten) targetDiaeten.value = diaeten;
                    
                    // Zeitausgleich setzen
                    if (zeitausgleich) {
                        const [hours, minutes] = zeitausgleich.split(':');
                        if (targetZeitausgleichH) targetZeitausgleichH.value = hours;
                        if (targetZeitausgleichM) targetZeitausgleichM.value = minutes;
                    }
                    
                    // Zeit in der Firma setzen
                    if (zeitFirma) {
                        const [hours, minutes] = zeitFirma.split(':');
                        if (targetZeitFirmaH) targetZeitFirmaH.value = hours;
                        if (targetZeitFirmaM) targetZeitFirmaM.value = minutes;
                    }
                    
                    // Zusätzliche Arbeitszeiten hinzufügen falls vorhanden
                    additionalTimes.forEach((time, index) => {
                        const blockNum = index + 2;
                        
                        // Füge Block hinzu falls noch nicht vorhanden
                        while (monthData[targetDay].timeBlocks < blockNum) {
                            addDayTimeBlock(targetDay);
                        }
                        
                        const startInput = document.getElementById(`start${blockNum}_${targetDay}`);
                        const endInput = document.getElementById(`end${blockNum}_${targetDay}`);
                        
                        if (startInput) startInput.value = time.start;
                        if (endInput) endInput.value = time.end;
                    });
                    
                    monthData[targetDay].isHoliday = isHoliday;
                    monthData[targetDay].hasPause = hasPause;
                    monthData[targetDay].dienst1 = dienst1;
                    monthData[targetDay].dienst2 = dienst2;
                    monthData[targetDay].einsatzpauschalen = einsatzpauschalen;
                    monthData[targetDay].krankUrlaub = krankUrlaub;
                    monthData[targetDay].diaeten = diaeten;
                    monthData[targetDay].zeitausgleich = zeitausgleich;
                    monthData[targetDay].zeitFirma = zeitFirma;
                    
                    updateDaySummary(targetDay);
                }
            }
            
            alert('Alle Daten wurden in die ganze Woche kopiert!');
        }

        function minutesToTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        function minutesToHours(minutes) {
            return (minutes / 60).toFixed(2);
        }

        function getWeekday(date) {
            const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            return days[date.getDay()];
        }

        function getWeekdayName(date) {
            const days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
            return days[date.getDay()];
        }

        function getFullWeekdayName(date) {
            const days = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            return days[date.getDay()];
        }

        // Österreichische Feiertage für Wien berechnen
        function calculateEaster(year) {
            // Gaußsche Osterformel
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const n = Math.floor((h + l - 7 * m + 114) / 31);
            const p = (h + l - 7 * m + 114) % 31;
            return new Date(year, n - 1, p + 1);
        }

        function getAustrianHolidays(year) {
            const easter = calculateEaster(year);
            const holidays = {};

            // Fixe Feiertage
            holidays[`${year}-01-01`] = 'Neujahr';
            holidays[`${year}-01-06`] = 'Heilige Drei Könige';
            holidays[`${year}-05-01`] = 'Tag der Arbeit';
            holidays[`${year}-08-15`] = 'Mariä Himmelfahrt';
            holidays[`${year}-10-26`] = 'Nationalfeiertag';
            holidays[`${year}-11-01`] = 'Allerheiligen';
            holidays[`${year}-12-08`] = 'Mariä Empfängnis';
            holidays[`${year}-12-25`] = 'Weihnachten';
            holidays[`${year}-12-26`] = 'Stefanitag';

            // Variable Feiertage (abhängig von Ostern)
            const easterMonday = new Date(easter);
            easterMonday.setDate(easter.getDate() + 1);
            holidays[easterMonday.toISOString().split('T')[0]] = 'Ostermontag';

            const ascensionDay = new Date(easter);
            ascensionDay.setDate(easter.getDate() + 39);
            holidays[ascensionDay.toISOString().split('T')[0]] = 'Christi Himmelfahrt';

            const whitMonday = new Date(easter);
            whitMonday.setDate(easter.getDate() + 50);
            holidays[whitMonday.toISOString().split('T')[0]] = 'Pfingstmontag';

            const corpusChristi = new Date(easter);
            corpusChristi.setDate(easter.getDate() + 60);
            holidays[corpusChristi.toISOString().split('T')[0]] = 'Fronleichnam';

            return holidays;
        }

        function isHoliday(date) {
            const year = date.getFullYear();
            const holidays = getAustrianHolidays(year);
            const dateString = date.toISOString().split('T')[0];
            return holidays[dateString] || null;
        }

        function getTimeRules(day, isHoliday) {
            if (isHoliday || day === 'sunday') {
                return [{ start: 0, end: 1440, type: 'tax_free_100' }];
            }

            switch (day) {
                case 'monday':
                    return [
                        { start: 0, end: 360, type: 'tax_free_100' },      // 0:00-6:00 (Nacht von So auf Mo)
                        { start: 360, end: 450, type: 'surcharge_50' },    // 6:00-7:30
                        { start: 450, end: 720, type: 'normal' },          // 7:30-12:00 (4.5h Normal)
                        { start: 720, end: 765, type: 'normal' },          // 12:00-12:45 (0.75h Normal oder Pause)
                        { start: 765, end: 1005, type: 'normal' },         // 12:45-16:45 (4h Normal)
                        { start: 1005, end: 1125, type: 'surcharge_50' },  // 16:45-18:45
                        { start: 1125, end: 1320, type: 'taxed_100' },     // 18:45-22:00
                        { start: 1320, end: 1440, type: 'tax_free_100' }   // 22:00-24:00 (Nacht)
                    ];
                case 'tuesday':
                case 'wednesday':
                case 'thursday':
                    return [
                        { start: 0, end: 360, type: 'tax_free_100' },      // 0:00-6:00 (Nacht)
                        { start: 360, end: 450, type: 'surcharge_50' },    // 6:00-7:30
                        { start: 450, end: 720, type: 'normal' },          // 7:30-12:00 (4.5h Normal)
                        { start: 720, end: 765, type: 'normal' },          // 12:00-12:45 (0.75h Normal oder Pause)
                        { start: 765, end: 1005, type: 'normal' },         // 12:45-16:45 (4h Normal)
                        { start: 1005, end: 1125, type: 'surcharge_50' },  // 16:45-18:45
                        { start: 1125, end: 1320, type: 'taxed_100' },     // 18:45-22:00
                        { start: 1320, end: 1440, type: 'tax_free_100' }   // 22:00-24:00 (Nacht)
                    ];
                case 'friday':
                    return [
                        { start: 0, end: 360, type: 'tax_free_100' },      // 0:00-6:00 (Nacht)
                        { start: 360, end: 450, type: 'surcharge_50' },    // 6:00-7:30
                        { start: 450, end: 720, type: 'normal' },          // 7:30-12:00 (4.5h Normal)
                        { start: 720, end: 1125, type: 'surcharge_50' },   // 12:00-18:45 (50% Zuschlag)
                        { start: 1125, end: 1320, type: 'taxed_100' },     // 18:45-22:00
                        { start: 1320, end: 1440, type: 'tax_free_100' }   // 22:00-24:00 (Nacht)
                    ];
                case 'saturday':
                    return [
                        { start: 0, end: 360, type: 'tax_free_100' },      // 0:00-6:00 (Nacht von Fr auf Sa)
                        { start: 360, end: 1320, type: 'taxed_100' },      // 6:00-22:00
                        { start: 1320, end: 1440, type: 'tax_free_100' }   // 22:00-24:00 (Beginn Wochenende)
                    ];
                default:
                    return [];
            }
        }

        function calculateTimeSegment(startTime, endTime, rules, day, hasPause = false) {
            const result = {
                normal: 0,
                surcharge_50: 0,
                taxed_100: 0,
                tax_free_100: 0
            };

            // Behandle Zeiten über Mitternacht (wenn Endzeit < Startzeit)
            if (endTime < startTime) {
                endTime += 1440; // Füge 24 Stunden hinzu
            }

            // Sonntag ist immer 100% steuerfrei
            // (Feiertage werden jetzt in calculateDayWorkTime behandelt)
            if (day === 'sunday') {
                result.tax_free_100 = endTime - startTime;
                return result;
            }

            // 3-Stunden-Regel: Wenn Block von 19:00 bis mindestens 22:00 geht (mindestens 3h)
            // dann ist der Zeitraum ab 19:00 bis Ende steuerfrei, der Rest wird normal berechnet
            const start19 = 19 * 60; // 19:00 in Minuten
            const end22 = 22 * 60;   // 22:00 in Minuten
            
            // Prüfe ob Block die 3-Stunden-Regel erfüllt:
            // 1. Block überschneidet sich mit Zeit ab 19:00
            // 2. Block geht mindestens bis 22:00
            // 3. Zeitraum von 19:00 bis Ende ist mindestens 3 Stunden
            
            const blockOverlaps19 = endTime > start19 && startTime < end22;
            const blockEndsAtOrAfter22 = endTime >= end22;
            
            if (blockOverlaps19 && blockEndsAtOrAfter22) {
                const timeFrom19 = endTime - Math.max(startTime, start19);
                
                if (timeFrom19 >= 180) { // mindestens 3 Stunden ab 19:00
                    // TEIL-BERECHNUNG: Block aufteilen
                    
                    // Teil VOR 19:00: normale Berechnung
                    if (startTime < start19) {
                        const preResult = calculateTimeSegmentNormal(startTime, start19, rules, day, hasPause);
                        result.normal += preResult.normal;
                        result.surcharge_50 += preResult.surcharge_50;
                        result.taxed_100 += preResult.taxed_100;
                        result.tax_free_100 += preResult.tax_free_100;
                    }
                    
                    // Teil AB 19:00: 100% steuerfrei
                    const steuerfrei_start = Math.max(startTime, start19);
                    result.tax_free_100 += endTime - steuerfrei_start;
                    
                    return result;
                }
            }

            // Normale Berechnung (wenn 3-Stunden-Regel nicht zutrifft)
            return calculateTimeSegmentNormal(startTime, endTime, rules, day, hasPause);
        }

        // Hilfsfunktion für normale Zeitberechnung
        function calculateTimeSegmentNormal(startTime, endTime, rules, day, hasPause = false) {
            const result = {
                normal: 0,
                surcharge_50: 0,
                taxed_100: 0,
                tax_free_100: 0
            };

            for (const rule of rules) {
                let ruleStart = rule.start;
                let ruleEnd = rule.end;
                
                // Wenn gesamte Arbeitszeit nach Mitternacht liegt
                if (startTime >= 1440) {
                    ruleStart += 1440;
                    ruleEnd += 1440;
                }
                
                const segmentStart = Math.max(startTime, ruleStart);
                const segmentEnd = Math.min(endTime, ruleEnd);
                
                if (segmentStart < segmentEnd) {
                    let minutes = segmentEnd - segmentStart;
                    let ruleType = rule.type;
                    
                    // Spezielle Behandlung für Mittagszeit 12:00-12:45 an Mo-Do
                    if ((day === 'monday' || day === 'tuesday' || day === 'wednesday' || day === 'thursday') &&
                        rule.start === 720 && rule.end === 765) { // 12:00-12:45
                        
                        if (hasPause) {
                            // Bei Pause: Diese Zeit gar nicht zählen
                            continue;
                        } else {
                            // Ohne Pause: Als 50% Zuschlag zählen
                            ruleType = 'surcharge_50';
                        }
                    }
                    
                    if (result[ruleType] !== undefined) {
                        result[ruleType] += minutes;
                    }
                }
            }

            return result;
        }

        function calculateDayWorkTime(timeBlocks, day, isHoliday, hasPause = false) {
            if (!timeBlocks || timeBlocks.length === 0) {
                return {
                    normal: 0,
                    surcharge_50: 0,
                    taxed_100: 0,
                    tax_free_100: 0,
                    break_time: 0,
                    display_break_time: 0
                };
            }

            const rules = getTimeRules(day, isHoliday);
            let totalResult = {
                normal: 0,
                surcharge_50: 0,
                taxed_100: 0,
                tax_free_100: 0,
                break_time: 0,
                display_break_time: 0
            };

            // Zuerst alle Bruttozeiten berechnen
            let bruttoMinutes = 0;
            for (const block of timeBlocks) {
                if (block.start && block.end) {
                    const start = timeToMinutes(block.start);
                    const end = timeToMinutes(block.end);
                    bruttoMinutes += (end - start);
                }
            }

            // Pausenzeit-Behandlung
            if (hasPause) {
                totalResult.break_time = 45;
                totalResult.display_break_time = 45;
            }

            // Für Feiertage: Bruttozeit als steuerfrei markieren (Pause wird später in displayResults abgezogen)
            if (isHoliday || day === 'sunday') {
                totalResult.tax_free_100 = bruttoMinutes; // KEINE Pausenabziehung hier!
                return totalResult;
            }

            // Normale Berechnung für Werktage
            for (const block of timeBlocks) {
                if (block.start && block.end) {
                    const start = timeToMinutes(block.start);
                    const end = timeToMinutes(block.end);
                    
                    const result = calculateTimeSegment(start, end, rules, day, hasPause);
                    Object.keys(totalResult).forEach(key => {
                        if (key !== 'break_time' && key !== 'display_break_time') {
                            totalResult[key] += result[key];
                        }
                    });
                }
            }

            // Pausenzeit für Werktage anpassen
            if (hasPause) {
                if (day === 'monday' || day === 'tuesday' || day === 'wednesday' || day === 'thursday') {
                    // Mo-Do: Pause ist bereits durch Überspringen der 12:00-12:45 Zeit berücksichtigt
                    totalResult.break_time = 0; // Nicht abziehen
                    totalResult.display_break_time = 45; // Nur zur Anzeige
                }
                // Freitag/Samstag: break_time bleibt 45 (wird abgezogen)
            }

            return totalResult;
        }

        function switchMode(mode) {
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(mode + '-mode').classList.add('active');
        }

        function calculateWorkTime() {
            const day = document.getElementById('workday').value;
            let isHoliday = document.getElementById('isHoliday').value === 'true';
            const hasPause = document.getElementById('hasPause').checked;
            
            // Sammle alle Arbeitszeit-Blöcke
            const timeBlocks = [];
            for (let i = 1; i <= singleModeTimeBlocks; i++) {
                const startTime = getTimeFromSelects(`startHour${i}`, `startMin${i}`);
                const endTime = getTimeFromSelects(`endHour${i}`, `endMin${i}`);
                
                if (startTime && endTime) {
                    timeBlocks.push({
                        start: startTime,
                        end: endTime
                    });
                }
            }

            if (timeBlocks.length === 0) {
                alert('Bitte geben Sie mindestens eine Arbeitszeit ein.');
                return;
            }

            // Validiere Zeitüberschneidungen
            const validation = validateTimeBlocks(timeBlocks);
            if (!validation.valid) {
                alert(validation.message);
                return;
            }

            const result = calculateDayWorkTime(timeBlocks, day, isHoliday, hasPause);
            displayResults(result);
        }

        function displayResults(result) {
            const resultDiv = document.getElementById('results');
            const resultContent = document.getElementById('resultContent');
            
            // Bruttoarbeitszeit (alle berechneten Zeitkategorien)
            const totalMinutes = result.normal + result.surcharge_50 + result.taxed_100 + result.tax_free_100;
            // Nettoarbeitszeit (Bruttozeit minus tatsächliche Pausenzeit)
            const workMinutes = totalMinutes - result.break_time;

            // DEBUG: Für Feiertage korrigieren
            // Bei Feiertagen sollte tax_free_100 gleich workMinutes sein
            const day = document.getElementById('workday').value;
            const isHoliday = document.getElementById('isHoliday').value === 'true';
            
            let displayTaxFree = result.tax_free_100;
            if (isHoliday || day === 'sunday') {
                // Bei Feiertagen: steuerfreie Zeit = Nettoarbeitszeit
                displayTaxFree = workMinutes;
            }

            resultContent.innerHTML = `
                <div class="result-item">
                    <div class="label">Gesamtarbeitszeit</div>
                    <div class="value">${minutesToHours(workMinutes)} h</div>
                </div>
                <div class="result-item">
                    <div class="label">Normalstunden</div>
                    <div class="value">${minutesToHours(result.normal)} h</div>
                </div>
                <div class="result-item">
                    <div class="label">50% Zuschlag</div>
                    <div class="value">${minutesToHours(result.surcharge_50)} h</div>
                </div>
                <div class="result-item">
                    <div class="label">100% versteuert</div>
                    <div class="value">${minutesToHours(result.taxed_100)} h</div>
                </div>
                <div class="result-item">
                    <div class="label">100% steuerfrei</div>
                    <div class="value">${minutesToHours(displayTaxFree)} h</div>
                </div>
                <div class="result-item">
                    <div class="label">Pausenzeit</div>
                    <div class="value">${minutesToHours(result.display_break_time || result.break_time)} h</div>
                </div>
            `;

            resultDiv.style.display = 'block';
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function clearSingle() {
            // Alle Arbeitszeit-Eingaben löschen
            for (let i = 1; i <= singleModeTimeBlocks; i++) {
                const startHourSelect = document.getElementById(`startHour${i}`);
                const startMinSelect = document.getElementById(`startMin${i}`);
                const endHourSelect = document.getElementById(`endHour${i}`);
                const endMinSelect = document.getElementById(`endMin${i}`);
                
                if (startHourSelect) startHourSelect.value = '';
                if (startMinSelect) startMinSelect.value = '';
                if (endHourSelect) endHourSelect.value = '';
                if (endMinSelect) endMinSelect.value = '';
            }
            
            // Zusätzliche Blöcke entfernen (nur 1 behalten)
            while (singleModeTimeBlocks > 1) {
                removeTimeBlock();
            }
            
            // Standardwerte wieder setzen
            document.getElementById('startHour1').value = '07';
            document.getElementById('startMin1').value = '30';
            document.getElementById('endHour1').value = '16';
            document.getElementById('endMin1').value = '45';
            
            document.getElementById('workday').value = 'monday';
            document.getElementById('isHoliday').value = 'false';
            document.getElementById('hasPause').checked = false;
            document.getElementById('results').style.display = 'none';
        }

        function generateMonthCalendar() {
            const monthInput = document.getElementById('selectedMonth').value;
            const employeeName = document.getElementById('employeeName').value;

            if (!monthInput || !employeeName) {
                alert('Bitte Name und Monat eingeben.');
                return;
            }

            const [year, month] = monthInput.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            
            monthData = {};
            
            const calendarDiv = document.getElementById('monthCalendar');
            calendarDiv.innerHTML = '';

            // Sammle Feiertage für diesen Monat
            const monthHolidays = [];
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const holidayName = isHoliday(date);
                if (holidayName) {
                    monthHolidays.push({ day, name: holidayName, date: getFullWeekdayName(date) });
                }
            }

            // Zeige Feiertags-Info an
            const holidaysInfoDiv = document.getElementById('holidaysInfo');
            const holidaysListDiv = document.getElementById('holidaysList');
            
            if (monthHolidays.length > 0) {
                holidaysInfoDiv.style.display = 'block';
                holidaysListDiv.innerHTML = monthHolidays.map(h => 
                    `<strong>${h.day}. ${new Date(year, month - 1, 1).toLocaleDateString('de-DE', { month: 'long' })} (${h.date}):</strong> ${h.name}`
                ).join('<br>');
            } else {
                holidaysInfoDiv.style.display = 'none';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const weekday = getWeekday(date);
                const weekdayName = getWeekdayName(date);
                const fullWeekdayName = getFullWeekdayName(date);
                
                // Prüfe auf Feiertag
                const holidayName = isHoliday(date);
                const isHolidayDay = holidayName !== null;
                
                const dayCard = document.createElement('div');
                dayCard.className = 'day-card';
                
                // Spezielle Styling für Feiertage
                if (isHolidayDay) {
                    dayCard.style.border = '2px solid #dc3545';
                    dayCard.style.background = 'linear-gradient(135deg, #fff5f5, #ffe6e6)';
                }
                
                dayCard.innerHTML = `
                    <div class="day-header">
                        <div class="day-number" style="${isHolidayDay ? 'color: #dc3545; font-weight: bold;' : ''}">${day}.</div>
                        <div class="weekday" style="${isHolidayDay ? 'color: #dc3545;' : ''}">${day}. ${fullWeekdayName}</div>
                    </div>
                    
                    ${isHolidayDay ? `
                    <div style="background: #dc3545; color: white; padding: 5px; border-radius: 5px; margin-bottom: 10px; text-align: center; font-size: 0.8rem; font-weight: bold;">
                        🎉 ${holidayName}
                    </div>
                    ` : ''}
                    
                    <div class="form-field" style="margin-bottom: 10px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 5px;">
                            <label style="font-size: 0.8rem;">
                                <input type="checkbox" id="holiday_${day}" onchange="updateDaySummary(${day})" ${isHolidayDay ? 'checked' : ''}> Feiertag
                            </label>
                            <label style="font-size: 0.8rem;">
                                <input type="checkbox" id="pause_${day}" onchange="updateDaySummary(${day})"> Pause (0:45h)
                            </label>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 5px;">
                            <label style="font-size: 0.8rem;">
                                <input type="checkbox" id="dienst1_${day}" onchange="updateDaySummary(${day})"> Dienst 1
                            </label>
                            <label style="font-size: 0.8rem;">
                                <input type="checkbox" id="dienst2_${day}" onchange="updateDaySummary(${day})"> Dienst 2
                            </label>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 5px;">
                            <label style="font-size: 0.8rem;">
                                Krank/Urlaub:
                                <select id="krankUrlaub_${day}" onchange="updateDaySummary(${day})" style="width: 100%; padding: 2px; font-size: 0.8rem;">
                                    <option value="">--</option>
                                    <option value="krank">Krank</option>
                                    <option value="urlaub">Urlaub</option>
                                </select>
                            </label>
                            <label style="font-size: 0.8rem;">
                                Diäten:
                                <select id="diaeten_${day}" onchange="updateDaySummary(${day})" style="width: 100%; padding: 2px; font-size: 0.8rem;">
                                    <option value="">--</option>
                                    <option value="kleine">kleine Diät</option>
                                    <option value="mittlere">mittlere Diät</option>
                                    <option value="grosse">große Diät</option>
                                </select>
                            </label>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 5px;">
                            <label style="font-size: 0.8rem;">
                                Zeitausgleich:
                                <div style="display: flex; gap: 2px; align-items: center;">
                                    <select id="zeitausgleichH_${day}" onchange="updateDaySummary(${day})" style="width: 50px; padding: 2px; font-size: 0.8rem;">
                                        <option value="">--</option>
                                        ${Array.from({length: 24}, (_, i) => `<option value="${i.toString().padStart(2, '0')}">${i.toString().padStart(2, '0')}</option>`).join('')}
                                    </select>
                                    <span>:</span>
                                    <select id="zeitausgleichM_${day}" onchange="updateDaySummary(${day})" style="width: 50px; padding: 2px; font-size: 0.8rem;">
                                        <option value="">--</option>
                                        <option value="00">00</option>
                                        <option value="15">15</option>
                                        <option value="30">30</option>
                                        <option value="45">45</option>
                                    </select>
                                </div>
                            </label>
                            <label style="font-size: 0.8rem;">
                                Zeit in der Firma:
                                <div style="display: flex; gap: 2px; align-items: center;">
                                    <select id="zeitFirmaH_${day}" onchange="updateDaySummary(${day})" style="width: 50px; padding: 2px; font-size: 0.8rem;">
                                        <option value="">--</option>
                                        ${Array.from({length: 24}, (_, i) => `<option value="${i.toString().padStart(2, '0')}">${i.toString().padStart(2, '0')}</option>`).join('')}
                                    </select>
                                    <span>:</span>
                                    <select id="zeitFirmaM_${day}" onchange="updateDaySummary(${day})" style="width: 50px; padding: 2px; font-size: 0.8rem;">
                                        <option value="">--</option>
                                        <option value="00">00</option>
                                        <option value="15">15</option>
                                        <option value="30">30</option>
                                        <option value="45">45</option>
                                    </select>
                                </div>
                            </label>
                        </div>
                        <div style="margin-top: 5px;">
                            <label style="font-size: 0.8rem; display: flex; align-items: center; gap: 5px;">
                                Einsatzpauschalen (1-9): 
                                <input type="number" 
                                       id="einsatzpauschalen_${day}" 
                                       min="1" 
                                       max="9" 
                                       style="width: 50px; padding: 2px; font-size: 0.8rem;" 
                                       onchange="updateDaySummary(${day})"
                                       placeholder="0">
                            </label>
                        </div>
                    </div>
                    
                    <div id="timeInputs_${day}">
                        <div class="input-labels">
                            <div>Beginn</div>
                            <div>Ende</div>
                        </div>
                        <div class="day-inputs-quick">
                            <input type="text" 
                                   class="time-input-quick" 
                                   id="start1_${day}" 
                                   data-day="${day}"
                                   placeholder="07:30"
                                   onkeydown="handleTimeKeyDown(event)"
                                   onblur="handleTimeBlur(event)"
                                   tabindex="${day * 10 + 1}">
                            <input type="text" 
                                   class="time-input-quick" 
                                   id="end1_${day}" 
                                   data-day="${day}"
                                   placeholder="16:45"
                                   onkeydown="handleTimeKeyDown(event)"
                                   onblur="handleTimeBlur(event)"
                                   tabindex="${day * 10 + 2}">
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 10px 0;">
                        <button type="button" onclick="addDayTimeBlock(${day})" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; margin: 2px;">+</button>
                        <button type="button" onclick="removeDayTimeBlock(${day})" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; margin: 2px;">-</button>
                        <button type="button" onclick="copyToWeek(${day})" style="background: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; margin: 2px;">📋 Woche</button>
                    </div>
                    
                    <div id="summary_${day}" class="day-summary">
                        ${isHolidayDay ? `<strong style="color: #dc3545;">Feiertag: ${holidayName}</strong>` : 'Keine Arbeitszeit eingetragen'}
                    </div>
                `;
                
                calendarDiv.appendChild(dayCard);
                
                monthData[day] = {
                    weekday: weekday,
                    date: date,
                    isHoliday: isHolidayDay,
                    holidayName: holidayName,
                    hasPause: false,
                    dienst1: false,
                    dienst2: false,
                    einsatzpauschalen: 0,
                    krankUrlaub: '',
                    diaeten: '',
                    zeitausgleich: '',
                    zeitFirma: '',
                    timeBlocks: 1
                };
            }
        }

        function getTimeFromDropdowns(hourId, minId) {
            const hourSelect = document.getElementById(hourId);
            const minSelect = document.getElementById(minId);
            
            if (!hourSelect || !minSelect || !hourSelect.value || !minSelect.value) {
                return '';
            }
            
            return `${hourSelect.value}:${minSelect.value}`;
        }

        function updateDaySummary(day) {
            const isHoliday = document.getElementById(`holiday_${day}`).checked;
            const hasPause = document.getElementById(`pause_${day}`).checked;
            const dienst1 = document.getElementById(`dienst1_${day}`).checked;
            const dienst2 = document.getElementById(`dienst2_${day}`).checked;
            const einsatzpauschalen = parseInt(document.getElementById(`einsatzpauschalen_${day}`).value) || 0;
            const krankUrlaub = document.getElementById(`krankUrlaub_${day}`).value;
            const diaeten = document.getElementById(`diaeten_${day}`).value;
            const zeitausgleich = getTimeFromDropdowns(`zeitausgleichH_${day}`, `zeitausgleichM_${day}`);
            const zeitFirma = getTimeFromDropdowns(`zeitFirmaH_${day}`, `zeitFirmaM_${day}`);
            
            monthData[day].isHoliday = isHoliday;
            monthData[day].hasPause = hasPause;
            monthData[day].dienst1 = dienst1;
            monthData[day].dienst2 = dienst2;
            monthData[day].einsatzpauschalen = einsatzpauschalen;
            monthData[day].krankUrlaub = krankUrlaub;
            monthData[day].diaeten = diaeten;
            monthData[day].zeitausgleich = zeitausgleich;
            monthData[day].zeitFirma = zeitFirma;
            
            const summaryDiv = document.getElementById(`summary_${day}`);
            
            // Bei Krank/Urlaub keine Arbeitszeit-Berechnung
            if (krankUrlaub) {
                let summaryText = `<strong>${krankUrlaub === 'krank' ? 'Krank' : 'Urlaub'}</strong>`;
                
                // Zusätzliche Informationen
                const additionalItems = [];
                if (dienst1) additionalItems.push('Dienst 1');
                if (dienst2) additionalItems.push('Dienst 2');
                if (einsatzpauschalen > 0) additionalItems.push(`${einsatzpauschalen} Einsatzpauschalen`);
                if (diaeten) additionalItems.push(`${diaeten} Diät`);
                if (zeitausgleich) additionalItems.push(`Zeitausgleich: ${zeitausgleich}h`);
                if (zeitFirma) additionalItems.push(`Zeit Firma: ${zeitFirma}h`);
                
                if (additionalItems.length > 0) {
                    summaryText += `<br><strong>Zusätzlich:</strong> ${additionalItems.join(', ')}`;
                }
                
                summaryDiv.innerHTML = summaryText;
                return;
            }
            
            // Sammle alle Arbeitszeit-Blöcke für diesen Tag
            const timeBlocks = [];
            for (let i = 1; i <= monthData[day].timeBlocks; i++) {
                const startTime = getTimeFromInput(`start${i}_${day}`);
                const endTime = getTimeFromInput(`end${i}_${day}`);
                
                if (startTime && endTime) {
                    timeBlocks.push({
                        start: startTime,
                        end: endTime
                    });
                }
            }
            
            // Validiere Zeitüberschneidungen
            if (timeBlocks.length > 1) {
                const validation = validateTimeBlocks(timeBlocks);
                if (!validation.valid) {
                    summaryDiv.innerHTML = `<span style="color: red; font-weight: bold;">❌ Zeitüberschneidung erkannt!</span><br><span style="font-size: 0.8rem;">Bitte korrigieren Sie die Arbeitszeiten.</span>`;
                    return;
                }
            }
            
            if (timeBlocks.length === 0 && !dienst1 && !dienst2 && einsatzpauschalen === 0 && !diaeten && !zeitausgleich && !zeitFirma) {
                summaryDiv.innerHTML = 'Keine Arbeitszeit eingetragen';
                return;
            }
            
            let summaryText = '';
            
            // Arbeitszeit-Zusammenfassung
            if (timeBlocks.length > 0) {
                const result = calculateDayWorkTime(timeBlocks, monthData[day].weekday, isHoliday, hasPause);
                // Bruttoarbeitszeit minus tatsächliche Pausenzeit = Nettoarbeitszeit
                const totalMinutes = result.normal + result.surcharge_50 + result.taxed_100 + result.tax_free_100;
                const workMinutes = totalMinutes - result.break_time;
                
                summaryText += `Arbeitszeit: ${minutesToHours(workMinutes)} h<br>`;
                summaryText += `Normal: ${minutesToHours(result.normal)} h | 50%: ${minutesToHours(result.surcharge_50)} h<br>`;
                summaryText += `100% versteuert: ${minutesToHours(result.taxed_100)} h | 100% steuerfrei: ${minutesToHours(result.tax_free_100)} h`;
                if ((result.display_break_time || result.break_time) > 0) {
                    summaryText += `<br>Pause: ${minutesToHours(result.display_break_time || result.break_time)} h`;
                }
                
                // Montagezulage berechnen (Gesamtstunden - Zeit in der Firma, oder gesamte Arbeitszeit wenn keine Firmenzeit)
                if (zeitFirma) {
                    const zeitFirmaMinuten = timeToMinutes(zeitFirma);
                    const montagezulageMinuten = workMinutes - zeitFirmaMinuten;
                    if (montagezulageMinuten > 0) {
                        summaryText += `<br>Montagezulage: ${minutesToHours(montagezulageMinuten)} h`;
                    }
                } else if (workMinutes > 0) {
                    // Keine Zeit in der Firma eingetragen = gesamte Arbeitszeit ist Montagezulage
                    summaryText += `<br>Montagezulage: ${minutesToHours(workMinutes)} h`;
                }
            }
            
            // Zusätzliche Dienste und Pauschalen
            const additionalItems = [];
            if (dienst1) additionalItems.push('Dienst 1');
            if (dienst2) additionalItems.push('Dienst 2');
            if (einsatzpauschalen > 0) additionalItems.push(`${einsatzpauschalen} Einsatzpauschalen`);
            if (diaeten) additionalItems.push(`${diaeten} Diät`);
            if (zeitausgleich) additionalItems.push(`Zeitausgleich: ${zeitausgleich}h`);
            if (zeitFirma) additionalItems.push(`Zeit Firma: ${zeitFirma}h`);
            
            if (additionalItems.length > 0) {
                if (summaryText) summaryText += '<br>';
                summaryText += `<strong>Zusätzlich:</strong> ${additionalItems.join(', ')}`;
            }
            
            summaryDiv.innerHTML = summaryText || 'Keine Arbeitszeit eingetragen';
        }

        function calculateMonthTotal() {
            if (Object.keys(monthData).length === 0) {
                alert('Bitte erst einen Monat generieren.');
                return;
            }

            let monthTotal = {
                normal: 0,
                surcharge_50: 0,
                taxed_100: 0,
                tax_free_100: 0,
                break_time: 0,
                display_break_time: 0,
                workDays: 0,
                totalWorkTime: 0,
                dienst1Count: 0,
                dienst2Count: 0,
                totalEinsatzpauschalen: 0,
                krankTage: 0,
                urlaubTage: 0,
                kleineDiaetCount: 0,
                mittlereDiaetCount: 0,
                grosseDiaetCount: 0,
                totalZeitausgleich: 0,
                totalMontagezulage: 0
            };

            const employeeName = document.getElementById('employeeName').value;
            const monthInput = document.getElementById('selectedMonth').value;

            for (const day in monthData) {
                const dayData = monthData[day];
                
                // Krank/Urlaub zählen
                if (dayData.krankUrlaub === 'krank') monthTotal.krankTage++;
                if (dayData.krankUrlaub === 'urlaub') monthTotal.urlaubTage++;
                
                // Bei Krank/Urlaub keine Arbeitszeit-Berechnung
                if (!dayData.krankUrlaub) {
                    // Sammle alle Arbeitszeit-Blöcke für diesen Tag
                    const timeBlocks = [];
                    for (let i = 1; i <= dayData.timeBlocks; i++) {
                        const startTime = getTimeFromInput(`start${i}_${day}`);
                        const endTime = getTimeFromInput(`end${i}_${day}`);
                        
                        if (startTime && endTime) {
                            timeBlocks.push({
                                start: startTime,
                                end: endTime
                            });
                        }
                    }
                    
                    // Validiere Zeitüberschneidungen - überspringe bei Fehlern
                    if (timeBlocks.length > 1) {
                        const validation = validateTimeBlocks(timeBlocks);
                        if (!validation.valid) {
                            // Überspringe diesen Tag bei der Berechnung
                            continue;
                        }
                    }
                    
                    // Arbeitszeit berechnen
                    if (timeBlocks.length > 0) {
                        const result = calculateDayWorkTime(timeBlocks, dayData.weekday, dayData.isHoliday, dayData.hasPause);
                        
                        Object.keys(result).forEach(key => {
                            if (monthTotal[key] !== undefined) {
                                monthTotal[key] += result[key];
                            }
                        });
                        
                        const totalMinutes = result.normal + result.surcharge_50 + result.taxed_100 + result.tax_free_100;
                        const workMinutes = totalMinutes - result.break_time;
                        
                        // Montagezulage berechnen
                        if (dayData.zeitFirma) {
                            const zeitFirmaMinuten = timeToMinutes(dayData.zeitFirma);
                            const montagezulageMinuten = workMinutes - zeitFirmaMinuten;
                            if (montagezulageMinuten > 0) {
                                monthTotal.totalMontagezulage += montagezulageMinuten;
                            }
                        } else if (workMinutes > 0) {
                            // Keine Zeit in der Firma = gesamte Arbeitszeit ist Montagezulage
                            monthTotal.totalMontagezulage += workMinutes;
                        }
                        
                        monthTotal.workDays++;
                    }
                }
                
                // Zeitausgleich summieren
                if (dayData.zeitausgleich) {
                    monthTotal.totalZeitausgleich += timeToMinutes(dayData.zeitausgleich);
                }
                
                // Zusätzliche Dienste und Pauschalen zählen
                if (dayData.dienst1) monthTotal.dienst1Count++;
                if (dayData.dienst2) monthTotal.dienst2Count++;
                if (dayData.einsatzpauschalen) monthTotal.totalEinsatzpauschalen += dayData.einsatzpauschalen;
                
                // Diäten zählen
                if (dayData.diaeten === 'kleine') monthTotal.kleineDiaetCount++;
                if (dayData.diaeten === 'mittlere') monthTotal.mittlereDiaetCount++;
                if (dayData.diaeten === 'grosse') monthTotal.grosseDiaetCount++;
            }

            monthTotal.totalWorkTime = monthTotal.normal + monthTotal.surcharge_50 + monthTotal.taxed_100 + monthTotal.tax_free_100 - monthTotal.break_time;

            const summaryDiv = document.getElementById('monthSummary');
            const summaryContent = document.getElementById('monthSummaryContent');
            
            summaryContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h4>Mitarbeiter: ${employeeName}</h4>
                    <h4>Monat: ${new Date(monthInput + '-01').toLocaleDateString('de-DE', { month: 'long', year: 'numeric' })}</h4>
                </div>
                
                <div class="result-grid">
                    <div class="result-item">
                        <div class="label">Arbeitstage</div>
                        <div class="value">${monthTotal.workDays}</div>
                    </div>
                    <div class="result-item">
                        <div class="label">Krank</div>
                        <div class="value">${monthTotal.krankTage}</div>
                    </div>
                    <div class="result-item">
                        <div class="label">Urlaub</div>
                        <div class="value">${monthTotal.urlaubTage}</div>
                    </div>
                    <div class="result-item">
                        <div class="label">Gesamtarbeitszeit</div>
                        <div class="value">${minutesToHours(monthTotal.totalWorkTime)} h</div>
                    </div>
                    <div class="result-item">
                        <div class="label">Normalstunden</div>
                        <div class="value">${minutesToHours(monthTotal.normal)} h</div>
                    </div>
                    <div class="result-item">
                        <div class="label">50% Zuschlag</div>
                        <div class="value">${minutesToHours(monthTotal.surcharge_50)} h</div>
                    </div>
                    <div class="result-item">
                        <div class="label">100% versteuert</div>
                        <div class="value">${minutesToHours(monthTotal.taxed_100)} h</div>
                    </div>
                    <div class="result-item">
                        <div class="label">100% steuerfrei</div>
                        <div class="value">${minutesToHours(monthTotal.tax_free_100)} h</div>
                    </div>
                    <div class="result-item">
                        <div class="label">Pausenzeit</div>
                        <div class="value">${minutesToHours(monthTotal.display_break_time || monthTotal.break_time)} h</div>
                    </div>
                    <div class="result-item">
                        <div class="label">Dienst 1</div>
                        <div class="value">${monthTotal.dienst1Count}x</div>
                    </div>
                    <div class="result-item">
                        <div class="label">Dienst 2</div>
                        <div class="value">${monthTotal.dienst2Count}x</div>
                    </div>
                    <div class="result-item">
                        <div class="label">Einsatzpauschalen</div>
                        <div class="value">${monthTotal.totalEinsatzpauschalen}</div>
                    </div>
                    <div class="result-item">
                        <div class="label">Kleine Diäten</div>
                        <div class="value">${monthTotal.kleineDiaetCount}x</div>
                    </div>
                    <div class="result-item">
                        <div class="label">Mittlere Diäten</div>
                        <div class="value">${monthTotal.mittlereDiaetCount}x</div>
                    </div>
                    <div class="result-item">
                        <div class="label">Große Diäten</div>
                        <div class="value">${monthTotal.grosseDiaetCount}x</div>
                    </div>
                    <div class="result-item">
                        <div class="label">Zeitausgleich</div>
                        <div class="value">${minutesToHours(monthTotal.totalZeitausgleich)} h</div>
                    </div>
                    <div class="result-item">
                        <div class="label">Montagezulage</div>
                        <div class="value">${minutesToHours(monthTotal.totalMontagezulage)} h</div>
                    </div>
                </div>
            `;

            generateOfficialPDF(employeeName, monthInput, monthTotal);
            summaryDiv.style.display = 'block';
            summaryDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function generateOfficialPDF(employeeName, monthInput, monthTotal) {
            const printTableDiv = document.getElementById('printTable');
            
            let tableHTML = `
                <div style="max-width: 210mm; margin: 0 auto; padding: 15mm; font-family: Arial, sans-serif; font-size: 10pt; background: white;">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <h2 style="margin: 0; font-size: 14pt; font-weight: bold;">STUNDENLISTE</h2>
                        <div style="font-size: 8pt; margin-top: 3px;">(Mittagspause von 12:00 bis 12:45 Uhr)</div>
                    </div>
                    
                    <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
                        <div>
                            <strong>NAME:</strong> <span style="border-bottom: 1px solid black; padding-bottom: 1px; min-width: 180px; display: inline-block;">${employeeName}</span>
                        </div>
                        <div>
                            <strong>Monat/Jahr:</strong> <span style="border-bottom: 1px solid black; padding-bottom: 1px; min-width: 120px; display: inline-block;">${new Date(monthInput + '-01').toLocaleDateString('de-DE', { month: '2-digit', year: 'numeric' }).replace('.', '/')}</span>
                        </div>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; border: 2px solid black; font-size: 7pt;">
                        <thead>
                            <tr style="border-bottom: 2px solid black;">
                                <th style="border: 1px solid black; padding: 2px; text-align: center; width: 7%; background: #f0f0f0; font-size: 7pt;">Datum</th>
                                <th style="border: 1px solid black; padding: 2px; text-align: center; width: 7%; background: #f0f0f0; font-size: 7pt;">VON</th>
                                <th style="border: 1px solid black; padding: 2px; text-align: center; width: 7%; background: #f0f0f0; font-size: 7pt;">BIS</th>
                                <th style="border: 1px solid black; padding: 2px; text-align: center; width: 7%; background: #f0f0f0; font-size: 7pt;">GESAMT</th>
                                <th style="border: 1px solid black; padding: 2px; text-align: center; width: 6%; background: #f0f0f0; font-size: 7pt;">Normal</th>
                                <th style="border: 1px solid black; padding: 2px; text-align: center; width: 6%; background: #f0f0f0; font-size: 7pt;">50%</th>
                                <th style="border: 1px solid black; padding: 2px; text-align: center; width: 6%; background: #f0f0f0; font-size: 7pt;">100%</th>
                                <th style="border: 1px solid black; padding: 2px; text-align: center; width: 6%; background: #f0f0f0; font-size: 7pt;">100% frei</th>
                                <th style="border: 1px solid black; padding: 2px; text-align: center; width: 8%; background: #f0f0f0; font-size: 6pt;">Dienst</th>
                                <th style="border: 1px solid black; padding: 2px; text-align: center; width: 8%; background: #f0f0f0; font-size: 6pt;">Einsatzpauschalen</th>
                                <th style="border: 1px solid black; padding: 2px; text-align: center; width: 8%; background: #f0f0f0; font-size: 6pt;">Diäten</th>
                                <th style="border: 1px solid black; padding: 2px; text-align: center; width: 8%; background: #f0f0f0; font-size: 6pt;">Zeitausgleich</th>
                                <th style="border: 1px solid black; padding: 2px; text-align: center; width: 8%; background: #f0f0f0; font-size: 6pt;">Montagezulage</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Generiere Tabellenzeilen für alle Tage des Monats
            const [year, month] = monthInput.split('-').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const paddedDay = day.toString().padStart(2, '0');
                const date = new Date(year, month - 1, day);
                const dateStr = `${paddedDay}.${month.toString().padStart(2, '0')}.`;
                
                let timeDisplay = '';
                let totalHours = '';
                let normal = '';
                let surcharge50 = '';
                let taxed100 = '';
                let taxFree100 = '';
                let dienstText = '';
                let einsatzpauschalenText = '';
                let diaetenText = '';
                let zeitausgleichText = '';
                let montagezulageText = '';
                let result = null;
                
                if (monthData[day]) {
                    // Bei Krank/Urlaub keine normalen Arbeitszeiten
                    if (monthData[day].krankUrlaub) {
                        timeDisplay = monthData[day].krankUrlaub === 'krank' ? 'Krank' : 'Urlaub';
                        totalHours = timeDisplay;
                    } else {
                        // Sammle alle Arbeitszeiten für diesen Tag
                        const timeBlocks = [];
                        for (let i = 1; i <= monthData[day].timeBlocks; i++) {
                            const startTime = getTimeFromInput(`start${i}_${day}`);
                            const endTime = getTimeFromInput(`end${i}_${day}`);
                            
                            if (startTime && endTime) {
                                timeBlocks.push({
                                    start: startTime,
                                    end: endTime
                                });
                            }
                        }
                        
                        if (timeBlocks.length > 0) {
                            timeDisplay = timeBlocks.map(block => `${block.start}-${block.end}`).join(', ');
                            
                            result = calculateDayWorkTime(timeBlocks, monthData[day].weekday, monthData[day].isHoliday, monthData[day].hasPause);
                            // Bruttoarbeitszeit minus tatsächliche Pausenzeit = Nettoarbeitszeit
                            const totalMinutes = result.normal + result.surcharge_50 + result.taxed_100 + result.tax_free_100;
                            const workMinutes = totalMinutes - result.break_time;
                            
                            totalHours = minutesToHours(workMinutes);
                            normal = minutesToHours(result.normal);
                            surcharge50 = minutesToHours(result.surcharge_50);
                            taxed100 = minutesToHours(result.taxed_100);
                            taxFree100 = minutesToHours(result.tax_free_100);
                            
                            // Montagezulage berechnen
                            if (monthData[day].zeitFirma) {
                                const zeitFirmaMinuten = timeToMinutes(monthData[day].zeitFirma);
                                const montagezulageMinuten = workMinutes - zeitFirmaMinuten;
                                if (montagezulageMinuten > 0) {
                                    montagezulageText = minutesToHours(montagezulageMinuten);
                                }
                            } else if (workMinutes > 0) {
                                // Keine Zeit in der Firma = gesamte Arbeitszeit ist Montagezulage
                                montagezulageText = minutesToHours(workMinutes);
                            }
                        }
                    }
                    
                    // Dienst-Informationen sammeln
                    const dienstItems = [];
                    if (monthData[day].dienst1) dienstItems.push('1.Dienst');
                    if (monthData[day].dienst2) dienstItems.push('2.Dienst');
                    dienstText = dienstItems.join(', ');
                    
                    // Einsatzpauschalen
                    einsatzpauschalenText = monthData[day].einsatzpauschalen > 0 ? monthData[day].einsatzpauschalen.toString() : '';
                    
                    // Diäten
                    if (monthData[day].diaeten === 'kleine') diaetenText = 'kleine';
                    if (monthData[day].diaeten === 'mittlere') diaetenText = 'mittlere';
                    if (monthData[day].diaeten === 'grosse') diaetenText = 'große';
                    
                    // Zeitausgleich
                    zeitausgleichText = monthData[day].zeitausgleich || '';
                }
                
                tableHTML += `
                    <tr style="height: 18px;">
                        <td style="border: 1px solid black; padding: 1px; text-align: center; font-size: 7pt;">${dateStr}</td>
                        <td style="border: 1px solid black; padding: 1px; text-align: center; font-size: 6pt;">${monthData[day] && monthData[day].krankUrlaub ? '' : (timeDisplay.includes(',') ? 'mehrere' : (timeDisplay.split(',')[0] ? timeDisplay.split(',')[0].split('-')[0] : ''))}</td>
                        <td style="border: 1px solid black; padding: 1px; text-align: center; font-size: 6pt;">${monthData[day] && monthData[day].krankUrlaub ? '' : (timeDisplay.includes(',') ? 'Zeiten' : (timeDisplay.split(',')[0] ? timeDisplay.split(',')[0].split('-')[1] : ''))}</td>
                        <td style="border: 1px solid black; padding: 1px; text-align: center; font-size: 7pt;">${totalHours}</td>
                        <td style="border: 1px solid black; padding: 1px; text-align: center; font-size: 7pt;">${normal}</td>
                        <td style="border: 1px solid black; padding: 1px; text-align: center; font-size: 7pt;">${surcharge50}</td>
                        <td style="border: 1px solid black; padding: 1px; text-align: center; font-size: 7pt;">${taxed100}</td>
                        <td style="border: 1px solid black; padding: 1px; text-align: center; font-size: 7pt;">${taxFree100}</td>
                        <td style="border: 1px solid black; padding: 1px; text-align: center; font-size: 6pt;">${dienstText}</td>
                        <td style="border: 1px solid black; padding: 1px; text-align: center; font-size: 7pt;">${einsatzpauschalenText}</td>
                        <td style="border: 1px solid black; padding: 1px; text-align: center; font-size: 6pt;">${diaetenText}</td>
                        <td style="border: 1px solid black; padding: 1px; text-align: center; font-size: 7pt;">${zeitausgleichText}</td>
                        <td style="border: 1px solid black; padding: 1px; text-align: center; font-size: 7pt;">${montagezulageText}</td>
                    </tr>
                `;
                
                // Wenn mehrere Arbeitszeiten vorhanden sind, füge eine Detail-Zeile hinzu
                if (timeDisplay.includes(',') && !monthData[day]?.krankUrlaub) {
                    tableHTML += `
                        <tr style="height: 12px; background: #f8f8f8;">
                            <td style="border: 1px solid black; padding: 1px; text-align: center; font-size: 6pt; font-style: italic;" colspan="13">
                                Zeiten: ${timeDisplay}
                            </td>
                        </tr>
                    `;
                }
            }

            tableHTML += `
                        </tbody>
                        <tfoot>
                            <tr style="background: #f0f0f0; font-weight: bold; border-top: 2px solid black;">
                                <td style="border: 1px solid black; padding: 2px; text-align: center; font-size: 7pt;">SUMME</td>
                                <td style="border: 1px solid black; padding: 2px; text-align: center;">-</td>
                                <td style="border: 1px solid black; padding: 2px; text-align: center;">-</td>
                                <td style="border: 1px solid black; padding: 2px; text-align: center; font-size: 7pt;">${minutesToHours(monthTotal.totalWorkTime)}</td>
                                <td style="border: 1px solid black; padding: 2px; text-align: center; font-size: 7pt;">${minutesToHours(monthTotal.normal)}</td>
                                <td style="border: 1px solid black; padding: 2px; text-align: center; font-size: 7pt;">${minutesToHours(monthTotal.surcharge_50)}</td>
                                <td style="border: 1px solid black; padding: 2px; text-align: center; font-size: 7pt;">${minutesToHours(monthTotal.taxed_100)}</td>
                                <td style="border: 1px solid black; padding: 2px; text-align: center; font-size: 7pt;">${minutesToHours(monthTotal.tax_free_100)}</td>
                                <td style="border: 1px solid black; padding: 2px; text-align: center; font-size: 6pt;">
                                    ${monthTotal.dienst1Count > 0 ? `1.D: ${monthTotal.dienst1Count}x` : ''}
                                    ${monthTotal.dienst1Count > 0 && monthTotal.dienst2Count > 0 ? '<br>' : ''}
                                    ${monthTotal.dienst2Count > 0 ? `2.D: ${monthTotal.dienst2Count}x` : ''}
                                </td>
                                <td style="border: 1px solid black; padding: 2px; text-align: center; font-size: 7pt;">${monthTotal.totalEinsatzpauschalen}</td>
                                <td style="border: 1px solid black; padding: 2px; text-align: center; font-size: 6pt;">
                                    ${monthTotal.kleineDiaetCount > 0 ? `kl: ${monthTotal.kleineDiaetCount}` : ''}
                                    ${(monthTotal.kleineDiaetCount > 0 && monthTotal.mittlereDiaetCount > 0) ? '<br>' : ''}
                                    ${monthTotal.mittlereDiaetCount > 0 ? `mi: ${monthTotal.mittlereDiaetCount}` : ''}
                                    ${((monthTotal.kleineDiaetCount > 0 || monthTotal.mittlereDiaetCount > 0) && monthTotal.grosseDiaetCount > 0) ? '<br>' : ''}
                                    ${monthTotal.grosseDiaetCount > 0 ? `gr: ${monthTotal.grosseDiaetCount}` : ''}
                                </td>
                                <td style="border: 1px solid black; padding: 2px; text-align: center; font-size: 7pt;">${minutesToHours(monthTotal.totalZeitausgleich)}</td>
                                <td style="border: 1px solid black; padding: 2px; text-align: center; font-size: 7pt;">${minutesToHours(monthTotal.totalMontagezulage)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;

            printTableDiv.innerHTML = tableHTML;
        }

        function printOfficialPDF() {
            const printTableDiv = document.getElementById('printTable');
            if (printTableDiv.innerHTML === '') {
                alert('Bitte erst die Monatsauswertung durchführen.');
                return;
            }
            
            const employeeName = document.getElementById('employeeName').value;
            const monthInput = document.getElementById('selectedMonth').value;
            
            // Erstelle Dateinamen im Format "JahrMonat_Name"
            const [year, month] = monthInput.split('-');
            const fileName = `${year}${month.padStart(2, '0')}_${employeeName.replace(/[^a-zA-Z0-9äöüß\s]/g, '').trim()}`;
            
            // Setze den Dokumenttitel für die PDF
            const originalTitle = document.title;
            document.title = fileName;
            
            printTableDiv.style.display = 'block';
            
            // Temporäre Styles für den Druck
            const originalStyles = document.head.innerHTML;
            document.head.innerHTML += `
                <style media="print">
                    body * { visibility: hidden; }
                    #printTable, #printTable * { visibility: visible; }
                    #printTable { 
                        position: absolute; 
                        left: 0; 
                        top: 0; 
                        width: 100%;
                        max-height: 100vh;
                        overflow: hidden;
                    }
                    @page { 
                        margin: 10mm; 
                        size: A4;
                    }
                    @media print {
                        html, body {
                            height: 100vh;
                            overflow: hidden;
                        }
                        * {
                            page-break-after: avoid !important;
                            page-break-before: avoid !important;
                            page-break-inside: avoid !important;
                        }
                    }
                </style>
            `;
            
            // Zeige Info-Dialog mit Dateinamen
            setTimeout(() => {
                alert(`💾 PDF-Dateiname:\n\n"${fileName}.pdf"\n\nWählen Sie im Druckdialog "Als PDF speichern" und verwenden Sie diesen Namen.`);
                window.print();
            }, 100);
            
            // Styles zurücksetzen
            setTimeout(() => {
                printTableDiv.style.display = 'none';
                document.head.innerHTML = originalStyles;
                document.title = originalTitle; // Titel zurücksetzen
            }, 2000);
        }

        function addTimeBlock() {
            singleModeTimeBlocks++;
            const additionalBlocks = document.getElementById('additionalTimeBlocks');
            
            const newBlock = document.createElement('div');
            newBlock.className = 'time-block';
            newBlock.id = `timeBlock${singleModeTimeBlocks}`;
            newBlock.innerHTML = `
                <h4>🕕 Zusätzliche Arbeitszeit ${singleModeTimeBlocks - 1}</h4>
                <div class="form-group">
                    <div class="form-field">
                        <label>Beginn</label>
                        <div class="time-input-group">
                            <select id="startHour${singleModeTimeBlocks}">
                                <option value="">--</option>
                            </select>
                            <span class="time-separator">:</span>
                            <select id="startMin${singleModeTimeBlocks}">
                                <option value="">--</option>
                                <option value="00">00</option>
                                <option value="15">15</option>
                                <option value="30">30</option>
                                <option value="45">45</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-field">
                        <label>Ende</label>
                        <div class="time-input-group">
                            <select id="endHour${singleModeTimeBlocks}">
                                <option value="">--</option>
                            </select>
                            <span class="time-separator">:</span>
                            <select id="endMin${singleModeTimeBlocks}">
                                <option value="">--</option>
                                <option value="00">00</option>
                                <option value="15">15</option>
                                <option value="30">30</option>
                                <option value="45">45</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            
            additionalBlocks.appendChild(newBlock);
            
            // Populate hour options for the new selects - WICHTIG!
            populateHourOptions(document.getElementById(`startHour${singleModeTimeBlocks}`));
            populateHourOptions(document.getElementById(`endHour${singleModeTimeBlocks}`));
        }

        function removeTimeBlock() {
            if (singleModeTimeBlocks > 1) {
                const blockToRemove = document.getElementById(`timeBlock${singleModeTimeBlocks}`);
                if (blockToRemove) {
                    blockToRemove.remove();
                }
                singleModeTimeBlocks--;
            }
        }

        function clearMonth() {
            monthData = {};
            document.getElementById('employeeName').value = '';
            document.getElementById('selectedMonth').value = '';
            document.getElementById('monthCalendar').innerHTML = '';
            document.getElementById('monthSummary').style.display = 'none';
            document.getElementById('printTable').innerHTML = '';
            document.getElementById('holidaysInfo').style.display = 'none';
        }

        // Beispielwerte setzen beim Laden
        document.addEventListener('DOMContentLoaded', function() {
            // Warte einen Moment, um sicherzustellen, dass alle Elemente geladen sind
            setTimeout(() => {
                // Populate hour options for initial time block
                populateHourOptions(document.getElementById('startHour1'));
                populateHourOptions(document.getElementById('endHour1'));
                
                // Standardwerte für Einzelberechnung setzen
                document.getElementById('startHour1').value = '07';
                document.getElementById('startMin1').value = '30';
                document.getElementById('endHour1').value = '16';
                document.getElementById('endMin1').value = '45';
                
                // Aktuellen Monat setzen
                const now = new Date();
                const currentMonth = now.getFullYear() + '-' + (now.getMonth() + 1).toString().padStart(2, '0');
                const monthSelect = document.getElementById('selectedMonth');
                if (monthSelect) {
                    monthSelect.value = currentMonth;
                }
            }, 100);
        });
    </script>
</body>
</html>